<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KNOVA Quest Think Tank - Live Session</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
        }

        /* Header */
        .header {
            background: rgba(15, 23, 42, 0.95);
            border-bottom: 2px solid #3b82f6;
            padding: 20px 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            color: #94a3b8;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 12px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Session View */
        .session-view {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: rgba(30, 41, 59, 0.5);
        }

        .session-view::-webkit-scrollbar {
            width: 8px;
        }

        .session-view::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
        }

        .session-view::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 4px;
        }

        /* Message Styling */
        .message {
            margin-bottom: 25px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
        }

        .avatar.ceo { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .avatar.strategy { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .avatar.technical { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .avatar.business { background: linear-gradient(135deg, #10b981, #059669); }
        .avatar.stanford { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .avatar.scribe { background: linear-gradient(135deg, #6366f1, #4f46e5); }

        .message-info {
            flex: 1;
        }

        .speaker-name {
            font-weight: 600;
            font-size: 14px;
            color: #60a5fa;
        }

        .speaker-role {
            font-size: 12px;
            color: #94a3b8;
        }

        .message-content {
            margin-left: 52px;
            padding: 15px 20px;
            background: rgba(15, 23, 42, 0.6);
            border-left: 3px solid #3b82f6;
            border-radius: 8px;
            line-height: 1.6;
        }

        .message-content h2,
        .message-content h3,
        .message-content h4 {
            color: #60a5fa;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .message-content h2 { font-size: 18px; }
        .message-content h3 { font-size: 16px; }
        .message-content h4 { font-size: 14px; }

        .message-content p {
            margin-bottom: 10px;
        }

        .message-content ul,
        .message-content ol {
            margin-left: 20px;
            margin-bottom: 10px;
        }

        .message-content li {
            margin-bottom: 5px;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
        }

        .message-content blockquote {
            border-left: 3px solid #3b82f6;
            padding-left: 15px;
            margin: 10px 0;
            color: #94a3b8;
            font-style: italic;
        }

        /* Input Area */
        .input-area {
            background: rgba(15, 23, 42, 0.95);
            border-top: 2px solid #3b82f6;
            padding: 20px 30px;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.3);
        }

        .input-label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 8px;
            display: block;
        }

        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid #334155;
            border-radius: 8px;
            padding: 12px 15px;
            color: #e2e8f0;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
            max-height: 200px;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(30, 41, 59, 1);
        }

        .send-button {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            height: 60px;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .send-button:active {
            transform: translateY(0);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(59, 130, 246, 0.2);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Helpers */
        .scroll-to-bottom {
            position: fixed;
            bottom: 140px;
            right: 40px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
            display: none;
        }

        .scroll-to-bottom.visible {
            display: block;
        }

        .scroll-to-bottom:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                    <h1>KNOVA Quest Think Tank Session</h1>
                    <div class="subtitle">Interactive Team Discussion</div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="sessionSelector" style="font-size: 12px; color: #94a3b8;">View Session:</label>
                    <select id="sessionSelector" style="background: rgba(30, 41, 59, 0.8); border: 2px solid #334155; border-radius: 6px; padding: 8px 12px; color: #e2e8f0; font-size: 13px; cursor: pointer; min-width: 380px; max-width: 500px;">
                        <option value="">Loading sessions...</option>
                    </select>
                    <span id="sessionInfo" style="font-size: 11px; color: #64748b; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></span>
                </div>
            </div>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span id="session-status">Session Active</span>
                </div>
                <div class="status-item">
                    <span id="participant-count">14 participants</span>
                </div>
                <div class="status-item">
                    <span id="last-update">Auto-refreshing...</span>
                </div>
            </div>
        </div>

        <!-- Session View -->
        <div class="session-view" id="sessionView">
            <div class="loading">
                <div class="spinner"></div>
                <div>Loading Think Tank session...</div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <label class="input-label">Your Message (Jeremy Potts - CEO):</label>
            <div class="input-container">
                <textarea
                    class="input-field"
                    id="userInput"
                    placeholder="Type your response or question here... Press Enter to send (Shift+Enter for new line)"
                    rows="2"
                ></textarea>
                <button class="send-button" id="sendButton">Send</button>
            </div>
        </div>
    </div>

    <!-- Scroll to Bottom Button -->
    <button class="scroll-to-bottom" id="scrollToBottom">↓</button>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8000/api';
        const REFRESH_INTERVAL = 2000; // 2 seconds

        let lastContent = '';
        let isUserScrolling = false;
        let autoScroll = true;
        let currentSessionFile = '';
        let availableSessions = [];
        let refreshInterval = null;

        // Parse speaker from markdown line
        function parseSpeaker(line) {
            const patterns = [
                { regex: /^#{3,4}\s+(.+?)\s*\((.+?)\):?$/i, nameGroup: 1, roleGroup: 2 },
                { regex: /^#{3,4}\s+(.+?):$/i, nameGroup: 1, roleGroup: null },
                { regex: /^\*\*(.+?)\s*\((.+?)\)\*\*:?$/i, nameGroup: 1, roleGroup: 2 },
                { regex: /^\*\*(.+?)\*\*:$/i, nameGroup: 1, roleGroup: null }
            ];

            for (const pattern of patterns) {
                const match = line.match(pattern.regex);
                if (match) {
                    return {
                        name: match[pattern.nameGroup].trim(),
                        role: pattern.roleGroup ? match[pattern.roleGroup].trim() : null
                    };
                }
            }
            return null;
        }

        // Get avatar class based on role or name
        function getAvatarClass(name, role) {
            const nameUpper = name.toUpperCase();
            const roleUpper = (role || '').toUpperCase();

            if (nameUpper.includes('JEREMY') || nameUpper.includes('POTTS')) return 'ceo';
            if (nameUpper.includes('VICTORIA') || nameUpper.includes('SCRIBE')) return 'scribe';
            if (roleUpper.includes('STANFORD') || nameUpper.includes('PROF') || nameUpper.includes('DR.')) return 'stanford';
            if (roleUpper.includes('STRATEGY') || nameUpper.includes('MORGAN')) return 'strategy';
            if (roleUpper.includes('TECHNICAL') || nameUpper.includes('ALEX')) return 'technical';
            if (roleUpper.includes('BUSINESS') || roleUpper.includes('FINANCIAL') || nameUpper.includes('RACHEL') || nameUpper.includes('MARCUS')) return 'business';

            return 'strategy';
        }

        // Get initials from name
        function getInitials(name) {
            return name.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2);
        }

        // Parse markdown into messages
        function parseMarkdown(content) {
            const lines = content.split('\n');
            const messages = [];
            let currentMessage = null;

            for (const line of lines) {
                const speaker = parseSpeaker(line);

                if (speaker) {
                    // Save previous message
                    if (currentMessage) {
                        messages.push(currentMessage);
                    }

                    // Start new message
                    currentMessage = {
                        name: speaker.name,
                        role: speaker.role || 'Team Member',
                        content: []
                    };
                } else if (currentMessage) {
                    // Add to current message content
                    if (line.trim() && !line.startsWith('---')) {
                        currentMessage.content.push(line);
                    }
                }
            }

            // Save last message
            if (currentMessage) {
                messages.push(currentMessage);
            }

            return messages;
        }

        // Render messages
        function renderMessages(messages) {
            const sessionView = document.getElementById('sessionView');
            const wasScrolledToBottom = sessionView.scrollHeight - sessionView.scrollTop === sessionView.clientHeight;

            sessionView.innerHTML = messages.map(msg => {
                const avatarClass = getAvatarClass(msg.name, msg.role);
                const initials = getInitials(msg.name);
                const contentHtml = marked.parse(msg.content.join('\n'));

                return `
                    <div class="message">
                        <div class="message-header">
                            <div class="avatar ${avatarClass}">${initials}</div>
                            <div class="message-info">
                                <div class="speaker-name">${msg.name}</div>
                                <div class="speaker-role">${msg.role}</div>
                            </div>
                        </div>
                        <div class="message-content">${contentHtml}</div>
                    </div>
                `;
            }).join('');

            // Auto-scroll if user was at bottom
            if (wasScrolledToBottom && !isUserScrolling) {
                sessionView.scrollTop = sessionView.scrollHeight;
            }
        }

        // Format session display name with date on the left
        function formatSessionDisplay(session) {
            let display = session.display_name || session.filename;
            
            // Format date for display (MM/DD/YYYY or show Unknown)
            let datePrefix = '';
            if (session.date && session.date !== 'Unknown') {
                const parts = session.date.split('-');
                if (parts.length === 3) {
                    datePrefix = `${parts[1]}/${parts[2]}/${parts[0]}`;
                } else {
                    datePrefix = session.date;
                }
            } else {
                datePrefix = 'No Date';
            }
            
            // Truncate long display names
            if (display.length > 45) {
                display = display.substring(0, 42) + '...';
            }
            
            return `${datePrefix} — ${display}`;
        }

        // Update session info display
        function updateSessionInfo(session) {
            const infoEl = document.getElementById('sessionInfo');
            if (!infoEl) return;
            
            const parts = [];
            if (session.format) {
                parts.push(session.format.toUpperCase());
            }
            if (session.date && session.date !== 'Unknown') {
                parts.push(session.date);
            }
            if (session.session_type) {
                parts.push(session.session_type);
            }
            
            infoEl.textContent = parts.join(' • ');
            infoEl.title = `File: ${session.filename}`;
        }

        // Load available sessions
        async function loadSessionList() {
            try {
                const response = await fetch(`${API_BASE}/sessions`);

                if (!response.ok) {
                    throw new Error(`Failed to load sessions: ${response.statusText}`);
                }

                availableSessions = await response.json();

                const selector = document.getElementById('sessionSelector');
                selector.innerHTML = '';

                if (availableSessions.length === 0) {
                    selector.innerHTML = '<option value="">No sessions found</option>';
                    document.getElementById('sessionInfo').textContent = '';
                    return;
                }

                // Sessions are already sorted by date (newest first) from server
                // Create flat list with dates shown
                availableSessions.forEach((session, index) => {
                    const option = document.createElement('option');
                    option.value = session.file;
                    option.textContent = formatSessionDisplay(session);
                    option.dataset.format = session.format || 'md';
                    option.dataset.sessionType = session.session_type || 'General';
                    option.dataset.date = session.date || 'Unknown';
                    selector.appendChild(option);
                });

                // Select most recent by default
                if (!currentSessionFile && availableSessions.length > 0) {
                    currentSessionFile = availableSessions[0].file;
                    selector.value = currentSessionFile;
                    updateSessionInfo(availableSessions[0]);
                }

                // Load the selected session
                if (currentSessionFile) {
                    await loadSession();
                }

            } catch (error) {
                console.error('Error loading session list:', error);
                const selector = document.getElementById('sessionSelector');
                selector.innerHTML = '<option value="">Error loading sessions</option>';
                document.getElementById('sessionInfo').textContent = 'Failed to load';
            }
        }

        // Load session content
        async function loadSession() {
            try {
                if (!currentSessionFile) {
                    return;
                }

                const response = await fetch(`${API_BASE}/session?file=${encodeURIComponent(currentSessionFile)}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const content = await response.text();

                if (content !== lastContent) {
                    lastContent = content;
                    const messages = parseMarkdown(content);
                    renderMessages(messages);

                    const now = new Date().toLocaleTimeString();
                    document.getElementById('last-update').textContent = `Last updated: ${now}`;

                    // Update status based on session
                    const isLatestSession = availableSessions.length > 0 &&
                                           currentSessionFile === availableSessions[0].file;
                    const statusText = isLatestSession ? 'Live Session' : 'Viewing Past Session';
                    const statusDot = document.querySelector('.status-dot');
                    const statusSpan = document.getElementById('session-status');

                    statusSpan.textContent = statusText;
                    statusDot.style.background = isLatestSession ? '#22c55e' : '#94a3b8';
                }
            } catch (error) {
                console.error('Error loading session:', error);
                document.getElementById('sessionView').innerHTML = `
                    <div class="loading">
                        <div style="color: #ef4444; margin-bottom: 15px;">⚠️ Error loading session</div>
                        <div style="font-size: 12px;">
                            ${error.message}<br><br>
                            Please ensure the Think Tank server is running:<br>
                            <code>python3 think-tank-server.py</code><br><br>
                            Then open: <code>http://localhost:8000/think-tank-viewer.html</code>
                        </div>
                    </div>
                `;
            }
        }

        // Switch session
        function switchSession(sessionFile) {
            currentSessionFile = sessionFile;
            lastContent = ''; // Force reload
            loadSession();

            // Find the selected session metadata
            const selectedSession = availableSessions.find(s => s.file === sessionFile);
            if (selectedSession) {
                updateSessionInfo(selectedSession);
            }

            // Update input field state - only allow input on the most recent session
            const isLatestSession = availableSessions.length > 0 &&
                                   sessionFile === availableSessions[0].file;
            const inputField = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');

            if (isLatestSession) {
                inputField.disabled = false;
                sendButton.disabled = false;
                inputField.placeholder = 'Type your response or question here... Press Enter to send (Shift+Enter for new line)';
            } else {
                inputField.disabled = true;
                sendButton.disabled = true;
                inputField.placeholder = 'Viewing past session (read-only)';
                inputField.value = '';
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();

            if (!message) return;

            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';

            try {
                const response = await fetch(`${API_BASE}/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        speaker: 'Jeremy Potts',
                        role: 'CEO'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to send message: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Message sent successfully:', result);

                // Clear input
                input.value = '';

                // Reload session immediately
                await loadSession();

                // Scroll to bottom
                const sessionView = document.getElementById('sessionView');
                sessionView.scrollTo({
                    top: sessionView.scrollHeight,
                    behavior: 'smooth'
                });
            } catch (error) {
                console.error('Error sending message:', error);
                alert(`Failed to send message: ${error.message}`);
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
                input.focus();
            }
        }

        // Event Listeners
        document.getElementById('sendButton').addEventListener('click', sendMessage);

        document.getElementById('userInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        document.getElementById('sessionSelector').addEventListener('change', (e) => {
            switchSession(e.target.value);
        });

        const sessionView = document.getElementById('sessionView');
        const scrollButton = document.getElementById('scrollToBottom');

        sessionView.addEventListener('scroll', () => {
            isUserScrolling = true;
            clearTimeout(sessionView.scrollTimeout);
            sessionView.scrollTimeout = setTimeout(() => {
                isUserScrolling = false;
            }, 1000);

            const isScrolledToBottom = sessionView.scrollHeight - sessionView.scrollTop === sessionView.clientHeight;
            scrollButton.classList.toggle('visible', !isScrolledToBottom);
        });

        scrollButton.addEventListener('click', () => {
            sessionView.scrollTo({
                top: sessionView.scrollHeight,
                behavior: 'smooth'
            });
        });

        // Initialize
        async function initialize() {
            await loadSessionList();

            // Only auto-refresh if viewing latest session
            refreshInterval = setInterval(() => {
                const isLatestSession = availableSessions.length > 0 &&
                                       currentSessionFile === availableSessions[0].file;
                if (isLatestSession) {
                    loadSession();
                }
            }, REFRESH_INTERVAL);
        }

        initialize();
    </script>
</body>
</html>
